## 简介

**声明合并(declaration merging)**是 TS 独有于 JS 的概念，了解什么是声明合并以及如何使用可以帮助我们如何给既有的 JS 代码添加 TS 能力。同时掌握声明合并的概念也有助于我们了解 TS 中更多更高级的抽象概念。好了，废话不多说，我们赶紧开始进入正题吧。

### 什么是声明合并

在 TS 中，如果我们声明了多个(**两个及以上**)相同名字的类型，ts compiler 会将这些声明合并为一个声明，这个声明同时具有之前那些声明的属性。

### interface merging

接口合并算是最基础也是最常用的，先来看一个最简单的例子

```tsx
interface Box {
    height: number;
    width: number;
}

interface Box {
    scale: number;
}

let box: Box = { height: 5, width: 6, scale: 10 };
```

上面定义了两个（也可以多个）名为**Box**的接口类型，每个类型中都只包含简单类型的属性**非函数属性(下面会讲到)**，Ts 会将这两个接口合并为一个，并包含所有的属性定义(见 box)。[在线试试](https://www.typescriptlang.org/play?#code/JYOwLgpgTgZghgYwgAgEIHsAeyDeAoZQ5ACwmAHNiwAuZEAVwFsAjaAbgKIHdgATMYrQYt2eAL548oSLEQoM2fEWQBnBHAA2EIU1ZQOEvFrDJmWWguQBeXCTKUayAKwAaZD36DkANjdrN2sgAjAAMyGJsQA)

那如果两个接口中包含相同的属性时，该如何合并呢？
这要分两种情况考虑，非函数属性和函数属性。  
**非函数属性**
Ts 规定，非函数属性在接口合并时会保持唯一，因此属性的类型必须是**相同**的，否则 Ts 会抛出错误。[在线试试](https://www.typescriptlang.org/play?#code/JYOwLgpgTgZghgYwgAgEIHsAeyDeAoZQ5ACwmAHNiwAuZEAVwFsAjaAbgKIHdgATMYrQYt2eAL548oSLEQoM2fEWQBnBHAA2EIU1ZQOEvFrDJmWWguQBeXCTKUayAKwAaZD36DkANjdrN2sgAjAAMyGJsQA)

**函数属性**
当 interface 中含有多个同名函数时，同名函数会发生 **重载*。关于函数重载有两条规则：

- 每个接口内的函数声明顺序保持不变，后合并的函数优先级要高于前面的函数。
- 当函数参数类型时**单个字面量**时，该函数无视第一条策略，会提升到重载列表的顶层。 
  
上面规则有些不好理解，我们通过实际例子来解释。  
定义一个名为 Demo 的接口，类型定义如下：    
```ts
interface Demo {
    setAge(a: number): number;
}
```
然后我们再声明一个名为 Demo 的接口，类型定义如下：  
```ts
interface Demo {
  setAge(p: { age: number }): number;
}
```
当 ts compile 检查到有同名接口后，会合并两个接口如下：  
```ts
interface Demo {
    setAge(p: { age: number }): number;
    setAge(a: number): number;
}
```
可以看到，`setAge(p: { age: number }): number` 这个函数生成被提升到了最上面，下面是演示效果([试一试](https://www.typescriptlang.org/play?ts=4.8.4#code/JYOwLgpgTgZghgYwgAgCIQLYHtkG8BQyyAzhGAIIDmEAFHAFzIgCuGARtAJSMvvQDc+AL75RoSLEQp02PIRJkqtAA6NcyONR6sOUZEO5MdA+QHpTCitRqrkAck0Q7h3rsEjRCLCGJhkAE0YZHABeOSJSKxU4KDgMTnCiZGAYZBowAE9lCCxU5Ri45BDi+1doZ0Sk5CgyZigQZHzYjEEqkSqUtMzs3MaCjCKSu18oUEoKgiqiGrA6hoAmVqT2pJm5vuaAOkclkQ9-TcilGk58IA)): 

![提示](../assets/declaration_merging/function_merge.png)   

我们对 Demo 再增加两个函数，不同的是函数参数是**单个字面量**    
```ts
interface Demo {
  setAge(a: number): number;
  setAge(p: 'unused'): number;
}


interface Demo {
  setAge(p: { age: number }): number;
  setAge(p: 'age'): number;
}
```
合并后的结果如下：  
```ts
interface Demo {
  setAge(p: 'unused'): number;
  setAge(p: 'age'): number;
  setAge(p: { age: number }): number;
  setAge(a: number): number;
}
```
可以看到，`setAge(p: 'unused'): number;` 和 `setAge(p: 'age'): number;` 这个函数生成被提升到了最上面，下面是演示效果([试一试](https://www.typescriptlang.org/play?ts=4.8.4&ssl=10&ssc=2&pln=1&pc=1#code/JYOwLgpgTgZghgYwgAgCIQLYHtkG8BQyyAzhGAIIDmEAFHAFzIgCuGARtAJSMvvQDchEmSq0ADowDkzFqQAmk7k1YcoggL74toSLEQp02PENIVqNCXmRxqPFdGTqlvVYKKnRFqTYiK7fNXxNLQQsEGIwZDlGQxwAXmN3EXMxOCg4DE5EomRgGGQaMABPMQgsfNT0jGQ42uRJF2hFbJzkKDJmKBBkSoy3HM1WvILi0vKetIyauskIqFBKZoJWonawTu6AJn6iQZy1jYmqgDoffs1guWOPc058IA)):    
![字面量被提升到了顶层](../assets/declaration_merging/string_literal.png)  
